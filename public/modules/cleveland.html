<form id='cleveland'>

<p>
Make a quick visual judgement:
</p>

<img id="cleveland-chart" height="300" />

<p>
Which of the two is smaller?
<input type="radio" name="perception" value="A" /> A
<input type="radio" name="perception" value="B" /> B
</p>

<p>
What percentage is the SMALLER of the LARGER? Enter a percentage between 0 and 100:
<br />
<br />
<input type="text" name="judgement" size="1" />%
</p>

<button type="button" disabled="true" id="next-chart">Next Chart</button>

</form>
  
<script> 
var cleveland = function() {
  // TODO randomize low, medlow, etcetera
  // TODO store chart order
  // TODO randomize chart type
  // TODO store chart type
  // TODO validate all values
  // TODO load new images via next button
  // TODO how to make images store correctly? maybe data['perception'+'-'+'low']? currentType?
  // TODO each chart in cleveland should be defined in one place via json, so storing the data for analysis becomes easier
  var data = {};
  var levels = ['low', 'medium', 'high'];
  var currentLevel = 0;
  var chart = 'bar-adjacent';

  init();

  function init() {
    d3.selectAll('input')
      .filter(function(d) { return this.name === 'perception' ? this : null; })
      .on('change', function() { data['perception'+'_'+levels[currentLevel]] = this.value; validate(); });
    d3.selectAll('input')
      .filter(function(d) { return this.name === 'judgement' ? this : null; })
      .on('change', function() { data['judgement'+'_'+levels[currentLevel]] = this.value; validate(); });
    d3.select('#next-chart')
      .on('click', nextChart);
    loadChart(0);
  }

  function nextChart() {
    currentLevel = currentLevel + 1;
    if( atLastChart() ){
      removeNextChartButton();
    }
    loadChart(currentLevel);
    resetAnswers();
    disableNextChartButton();
  }

  function removeNextChartButton() {
    d3.select('#next-chart').remove();
  }

  function atLastChart() {
    return currentLevel === levels.length-1;
  }

  function loadChart(x) {
    var level = levels[x];
    d3.select('#cleveland-chart')
      .attr('src', 'modules/img/'+chart+'-'+level+'.png');
  }

  function resetAnswers() {
    d3.select('#cleveland').node().reset();
  }

  function validate() {
    if(data['perception'+'_'+levels[currentLevel]] && data['judgement'+'_'+levels[currentLevel]]){
      enableNextChartButton();
    }

    if( data.perception_medium && data.judgement_medium &&
        data.perception_high   && data.judgement_high  ) {
      experimentr.save(data);
      experimentr.release();
    }
  }

  function disableNextChartButton() {
    d3.select('#next-chart').attr('disabled', true);
  }

  function enableNextChartButton() {
    d3.select('#next-chart').attr('disabled', null);
  }
}();
</script>
