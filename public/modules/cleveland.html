<form id='cleveland'>

<p>
Make a <strong>quick</strong> visual judgement:
</p>

<div>
  <img id="cleveland-chart" height="380" />
  <div id="cleveland-questions">

  <div id="perception">
  <p>
  Which of the two is smaller?
  </p>
  <p>
  <input type="radio" name="perception" value="A" /> A
  <input type="radio" name="perception" value="B" /> B
  </p>
  <br>
  <p>
  <button type="button" disabled="true" id="next-chart">Next Chart</button>
  </p>
  </div>
  
  <div id="judgement">
  <p>
  What percentage is the SMALLER of the LARGER? Enter a percentage between 1 and 100:
  </p>
  <p>
  <input type="text" name="judgement" size="2" />%
  <span id="error"></span>
  </p>
  <br>
  </div>

  </div>
</div>


</form>

<style>
  #perception {
    float: left;
    width: 250px;
    padding-left: 64px; 
  }
  #judgement {
    float: left;
    width: 250px;
    padding-left: 64px; 
  }
  #cleveland-questions {
    width 500px;
    overflow: auto;
  }
  #cleveland-chart {
    display: inline-block;
    margin: auto;
    vertical-align: top;
  }
  #error {
    color: red;
  }
</style>
  
<script> 
var cleveland = function() {
  var data         = {}
    , levels       = ['low', 'mediumLow', 'medium', 'mediumHigh', 'high']
    , currentLevel = 0
    , charts       = ['bar-adjacent', 'bar-nonAdjacentOne', 'bar-nonAdjacentThree', 'bar-nonAdjacentFive', 'bar-nonAdjacentSeven'];
    //, charts       = ['bar-adjacent', 'bar-nonadjacent'];

  // barTen actual
  var actual = {
    "low": 85,
    "mediumLow": 68,
    "medium": 46,
    "mediumHigh": 37,
    "high": 14
  };

  // 2-chart actual
  //var actual = {
  //  "low": 84,
  //  "mediumLow": 61,
  //  "medium": 50,
  //  "mediumHigh": 37,
  //  "high": 13
  //};

  data.chart      = charts[getRandomInt(0, charts.length-1)];
  data.levelOrder = shuffle(levels);

  init();

  function init() {
    experimentr.hideNext();
    d3.selectAll('input')
      .filter(function(d) { return this.name === 'perception' ? this : null; })
      .on('change', function() { data['perception'+'_'+data.levelOrder[currentLevel]] = this.value; validate(); });
    d3.selectAll('input')
      .filter(function(d) { return this.name === 'judgement' ? this : null; })
      .on('keypress', function() { data['judgement'+'_'+data.levelOrder[currentLevel]] = this.value; validate(); })
      .on('blur', function() { data['judgement'+'_'+data.levelOrder[currentLevel]] = this.value; validate(); });
    d3.select('#next-chart')
      .on('click', nextChart);
    loadChart(0);
  }

  function nextChart() {
    if ( !currentAnswerIsNumber() ) {
      showError("Please enter a number between 1 and 100 (no characters, no decimals)");
      return;
    }
    currentLevel = currentLevel + 1;
    if( atLastChart() ){
      removeNextChartButton();
      experimentr.showNext();
    }
    loadChart(currentLevel);
    resetAnswers();
    clearError();
    disableNextChartButton();
  }

  function removeNextChartButton() {
    d3.select('#next-chart').remove();
  }

  function atLastChart() {
    return currentLevel === data.levelOrder.length-1;
  }

  function loadChart(x) {
    var level = data.levelOrder[x];
    d3.select('#cleveland-chart')
      .attr('src', 'modules/img/barTen/'+data.chart+'-'+level+'.png');
    experimentr.startTimer(level);
  }

  function resetAnswers() {
    d3.select('#cleveland').node().reset();
  }

  function validate() {
    if( currentQuestionsComplete() ) {
      experimentr.endTimer(data.levelOrder[currentLevel]);
      enableNextChartButton();
    }
    if( allDataCollected() ) {
      gradeAnswers();
      experimentr.addData(data);
      experimentr.release();
    }
  }

  function allDataCollected() {
    return data.perception_low         &&  data.judgement_low &&
           data.perception_mediumLow   &&  data.judgement_mediumLow && 
           data.perception_medium      &&  data.judgement_medium && 
           data.perception_mediumHigh  &&  data.judgement_mediumHigh && 
           data.perception_high        &&  data.judgement_high && 
           data.chart                  &&  data.levelOrder;
  }

  function gradeAnswers() {
    // barTen data
    data.perceptionAnswer_low        = data.perception_low === "A" ? true : false;
    data.perceptionAnswer_mediumLow  = data.perception_mediumLow === "A" ? true : false;
    data.perceptionAnswer_medium     = data.perception_medium === "A" ? true : false;
    data.perceptionAnswer_mediumHigh = data.perception_mediumHigh === "A" ? true : false;
    data.perceptionAnswer_high       = data.perception_high === "B" ? true : false;

    // old data
//    data.perceptionAnswer_low        = data.perception_low === "A" ? true : false;
//    data.perceptionAnswer_mediumLow  = data.perception_mediumLow === "A" ? true : false;
//    data.perceptionAnswer_medium     = data.perception_medium === "A" ? true : false;
//    data.perceptionAnswer_mediumHigh = data.perception_mediumHigh === "A" ? true : false;
//    data.perceptionAnswer_high       = data.perception_high === "A" ? true : false;

    data.error_low        = actual.low - data.judgement_low;
    data.error_mediumLow  = actual.mediumLow - data.judgement_mediumLow;
    data.error_medium     = actual.medium - data.judgement_medium;
    data.error_mediumHigh = actual.mediumHigh - data.judgement_mediumHigh;
    data.error_high       = actual.high - data.judgement_high;

    data.error_total = data.error_low + data.error_mediumLow + data.error_medium
      + data.error_mediumHigh + data.error_high;

    data.error_average = data.error_total / levels.length;

    data.cm_low        = clevelandError(actual.low, data.judgement_low);
    data.cm_mediumLow  = clevelandError(actual.mediumLow, data.judgement_mediumLow);
    data.cm_medium     = clevelandError(actual.medium, data.judgement_medium);
    data.cm_mediumHigh = clevelandError(actual.mediumHigh, data.judgement_mediumHigh);
    data.cm_high       = clevelandError(actual.high, data.judgement_high);

    data.cm_total = data.cm_low + data.cm_mediumLow + data.cm_medium
      + data.cm_mediumHigh + data.cm_high;

    data.cm_average = data.cm_total / levels.length;
  }

  function clevelandError(actual, judged) {
    return Math.log( Math.abs( judged - actual ) + .125 ) / Math.log(2);
  }

  function currentQuestionsComplete() {
    return data['perception'+'_'+data.levelOrder[currentLevel]] && data['judgement'+'_'+data.levelOrder[currentLevel]];
  }

  function showError(d) {
    d3.select('#cleveland').select('#error').text(d);
  }

  function clearError(d) {
    d3.select('#cleveland').select('#error').text('');
  }

  function currentAnswerIsNumber() {
    var d = data['judgement'+'_'+data.levelOrder[currentLevel]];
    return isNumber(d) ? (d >= 1 && d <= 100) : false;
  }

  function isNumber(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
  }

  function disableNextChartButton() {
    d3.select('#next-chart').attr('disabled', true);
  }

  function enableNextChartButton() {
    d3.select('#next-chart').attr('disabled', null);
  }

  function getRandomInt (min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function shuffle (o) {
    for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
      return o;
  }
}();
</script>
