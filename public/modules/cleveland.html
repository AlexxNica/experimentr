<form id='cleveland'>

<p>
Make a <strong>quick</strong> visual judgement <span id="progress"></span>:
</p>

<div>
  <img id="cleveland-chart" height="380" />
  <div id="cleveland-questions">

  <div id="perception">
  <p>
  Which of the two is smaller?
  </p>
  <p>
  <input type="radio" name="perception" value="A" /> A
  <input type="radio" name="perception" value="B" /> B
  </p>
  <br>
  <p>
  <button type="button" disabled="true" id="next-chart">Next Chart</button>
  </p>
  </div>
  
  <div id="judgement">
  <p>
  What percentage is the SMALLER of the LARGER? Enter a percentage between 1 and 100:
  </p>
  <p>
  <input type="text" name="judgement" size="2" />%
  <span id="error"></span>
  </p>
  <br>
  </div>

  </div>
</div>


</form>

<style>
  #perception {
    float: left;
    width: 250px;
    padding-left: 64px; 
  }
  #judgement {
    float: left;
    width: 250px;
    padding-left: 64px; 
  }
  #cleveland-questions {
    width 500px;
    overflow: auto;
  }
  #cleveland-chart {
    display: inline-block;
    margin: auto;
    vertical-align: top;
  }
  #error {
    color: red;
  }
</style>
  
<script> 
var cleveland = function() {
  var data         = {}
  , levels         = [
      'practice', 
      'low0', 'low1', 'low2', 'low3',
      'mediumLow0', 'mediumLow1', 'mediumLow2', 'mediumLow3',
      'medium0', 'medium1', 'medium2', 'medium3',
      'mediumHigh0', 'mediumHigh1', 'mediumHigh2', 'mediumHigh3',
      'high0', 'high1', 'high2', 'high3'
    ]
    , currentLevel = 0
    , charts       = ['adjacent_10', 'nonAdjacent_3_10', 'nonAdjacent_5_10', 'nonAdjacent_20_40'];

  // barTen actual
  var actual = {
    "practice":     52,
    "low0":         94,
    "low1":         89,
    "low2":         80,
    "low3":         85,
    "mediumLow0":   60,
    "mediumLow1":   62,
    "mediumLow2":   65,
    "mediumLow3":   68,
    "medium0":      55,
    "medium1":      41,
    "medium2":      51,
    "medium3":      44,
    "mediumHigh0":  39,
    "mediumHigh1":  23,
    "mediumHigh2":  21,
    "mediumHigh3":  33,
    "high0":        9,
    "high1":        8,
    "high2":        16,
    "high3":        13
  };

  var percepts = {
    "practice":     'B',
    "low0":         'B',
    "low1":         'B',
    "low2":         'A',
    "low3":         'B',
    "mediumLow0":   'A',
    "mediumLow1":   'A',
    "mediumLow2":   'B',
    "mediumLow3":   'A',
    "medium0":      'B',
    "medium1":      'B',
    "medium2":      'B',
    "medium3":      'A',
    "mediumHigh0":  'B',
    "mediumHigh1":  'A',
    "mediumHigh2":  'B',
    "mediumHigh3":  'A',
    "high0":        'A',
    "high1":        'A',
    "high2":        'B',
    "high3":        'A'
  };

  data.chart      = charts[getRandomInt(0, charts.length-1)];
  // keep the first level, but shuffle the rest
  data.levelOrder = [levels[0]].concat( shuffle(levels.slice(1)) );

  init();

  function init() {
    experimentr.hideNext();
    d3.selectAll('input')
      .filter(function(d) { return this.name === 'perception' ? this : null; })
      .on('change', function() { data['perception'+'_'+data.levelOrder[currentLevel]] = this.value; validate(); });
    d3.selectAll('input')
      .filter(function(d) { return this.name === 'judgement' ? this : null; })
      .on('keypress', function() { data['judgement'+'_'+data.levelOrder[currentLevel]] = this.value; validate(); })
      .on('blur', function() { data['judgement'+'_'+data.levelOrder[currentLevel]] = this.value; validate(); });
    d3.select('#next-chart')
      .on('click', nextChart);
    loadChart(0);
  }

  function updateProgress(d) {
    d3.select('#progress').text(''+d+'/'+levels.length);
  }

  function nextChart() {
    if ( !currentAnswerIsNumber() ) {
      showError("Please enter a number between 1 and 100 (no characters, no decimals)");
      return;
    }
    currentLevel = currentLevel + 1;
    if( atLastChart() ){
      removeNextChartButton();
      experimentr.showNext();
    }
    loadChart(currentLevel);
    resetAnswers();
    clearError();
    disableNextChartButton();
  }

  function removeNextChartButton() {
    d3.select('#next-chart').remove();
  }

  function atLastChart() {
    return currentLevel === data.levelOrder.length-1;
  }

  function loadChart(x) {
    var level = data.levelOrder[x];
    updateProgress(x);
    d3.select('#cleveland-chart')
      .attr('src', 'modules/img/pilot2/'+data.chart+'-'+level+'.png');
    experimentr.startTimer(level);
  }

  function resetAnswers() {
    d3.select('#cleveland').node().reset();
  }

  function validate() {
    if( currentQuestionsComplete() ) {
      experimentr.endTimer(data.levelOrder[currentLevel]);
      enableNextChartButton();
    }
    if( atLastChart() ) {
      gradeAnswers();
      experimentr.addData(data);
      experimentr.release();
    }
  }

  function gradeAnswers() {
    var noPracticeLevels = levels.slice(1);
    // perception
    levels.forEach(function(d) {
      data['perceptionAnswer_'+d] = data['perception_'+d] === percepts[d] ? true : false;
    });
    // error
    levels.forEach(function(d) {
      data['error_'+d] = actual[d] - data['judgement_'+d];
    });
    // cm
    levels.forEach(function(d) {
      data['cm_'+d] = clevelandError(actual[d], data['judgement_'+d]);
    }, 0);

    // error
    data.error_total = noPracticeLevels.reduce(function(pv, cv, i, arr){
      return parseFloat(pv) + parseFloat(data['error_'+cv]);
    }, 0);
    data.error_average = data.error_total / noPracticeLevels.length;

    // cm
    data.cm_total = noPracticeLevels.reduce(function(pv, cv, i, arr){
      return parseFloat(pv) + parseFloat(data['cm_'+cv]);
    }, 0);
    data.cm_average = data.cm_total / noPracticeLevels.length;

    // average time
    var ed = experimentr.data();
    data.time_diff_total = noPracticeLevels.reduce(function(pv, cv, i, arr){
      return parseFloat(pv) + parseFloat(ed['time_diff_'+cv]);
    }, 0);
    data.time_diff_average = data.time_diff_total / noPracticeLevels.length;
  }

  function clevelandError(actual, judged) {
    return Math.log( Math.abs( judged - actual ) + .125 ) / Math.log(2);
  }

  function currentQuestionsComplete() {
    return data['perception'+'_'+data.levelOrder[currentLevel]] && data['judgement'+'_'+data.levelOrder[currentLevel]];
  }

  function showError(d) {
    d3.select('#cleveland').select('#error').text(d);
  }

  function clearError(d) {
    d3.select('#cleveland').select('#error').text('');
  }

  function currentAnswerIsNumber() {
    var d = data['judgement'+'_'+data.levelOrder[currentLevel]];
    return isNumber(d) ? (d >= 1 && d <= 100) : false;
  }

  function isNumber(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
  }

  function disableNextChartButton() {
    d3.select('#next-chart').attr('disabled', true);
  }

  function enableNextChartButton() {
    d3.select('#next-chart').attr('disabled', null);
  }

  function getRandomInt (min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function shuffle (o) {
    for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
      return o;
  }
}();
</script>
