<form id='cleveland'>

<p>
Make a quick visual judgement:
</p>

<img id="cleveland-chart" height="380" />

<p>
Which of the two is smaller?
</p>
<p>
<input type="radio" name="perception" value="A" /> A
<input type="radio" name="perception" value="B" /> B
</p>

<p>
What percentage is the SMALLER of the LARGER? 
</p>
<p>
Enter a percentage between 0 and 100:
<br />
<input type="text" name="judgement" size="2" />%
</p>

<button type="button" disabled="true" id="next-chart">Next Chart</button>
<span id="error"></span>

</form>

<style>
  #cleveland-chart {
    display: block;
    margin: auto;
  }
  #error {
    color: red;
  }
</style>
  
<script> 
var cleveland = function() {
  var data         = {}
    , levels       = ['low', 'mediumLow', 'medium', 'mediumHigh', 'high']
    , currentLevel = 0
    , charts       = ['bar-adjacent', 'bar-nonadjacent'];


  var actual = {
    "low": 84,
    "mediumLow": 61,
    "medium": 50,
    "mediumHigh": 37,
    "high": 13
  };

  data.chart      = charts[getRandomInt(0, 1)];
  data.levelOrder = shuffle(levels);

  init();

  function init() {
    d3.selectAll('input')
      .filter(function(d) { return this.name === 'perception' ? this : null; })
      .on('change', function() { data['perception'+'_'+data.levelOrder[currentLevel]] = this.value; validate(); });
    d3.selectAll('input')
      .filter(function(d) { return this.name === 'judgement' ? this : null; })
      .on('keypress', function() { data['judgement'+'_'+data.levelOrder[currentLevel]] = this.value; validate(); })
      .on('blur', function() { data['judgement'+'_'+data.levelOrder[currentLevel]] = this.value; validate(); });
    d3.select('#next-chart')
      .on('click', nextChart);
    loadChart(0);
  }

  function nextChart() {
    if ( !currentAnswerIsNumber() ) {
      showError("Please enter a number between 0 and 100 (no characters)");
      return;
    }
    currentLevel = currentLevel + 1;
    if( atLastChart() ){
      removeNextChartButton();
    }
    loadChart(currentLevel);
    resetAnswers();
    clearError();
    disableNextChartButton();
  }

  function removeNextChartButton() {
    d3.select('#next-chart').remove();
  }

  function atLastChart() {
    return currentLevel === data.levelOrder.length-1;
  }

  function loadChart(x) {
    var level = data.levelOrder[x];
    d3.select('#cleveland-chart')
      .attr('src', 'modules/img/'+data.chart+'-'+level+'.png');
  }

  function resetAnswers() {
    d3.select('#cleveland').node().reset();
  }

  function validate() {
    if( currentQuestionsComplete() ) {
      enableNextChartButton();
    }
    if( allDataCollected() ) {
      gradeAnswers();
      experimentr.addData(data);
      experimentr.release();
    }
  }

  // TODO function to check all levels
  function allDataCollected() {
    return data.perception_low         &&  data.judgement_low &&
           data.perception_mediumLow   &&  data.judgement_mediumLow && 
           data.perception_medium      &&  data.judgement_medium && 
           data.perception_mediumHigh  &&  data.judgement_mediumHigh && 
           data.perception_high        &&  data.judgement_high && 
           data.chart                  &&  data.levelOrder;
  }

  function gradeAnswers() {
    data.perceptionAnswer_low        = data.perception_low === "A" ? true : false;
    data.perceptionAnswer_mediumLow  = data.perception_mediumLow === "A" ? true : false;
    data.perceptionAnswer_medium     = data.perception_medium === "A" ? true : false;
    data.perceptionAnswer_mediumHigh = data.perception_mediumHigh === "A" ? true : false;
    data.perceptionAnswer_high       = data.perception_high === "A" ? true : false;

    data.error_low        = actual.low - data.judgement_low;
    data.error_mediumLow  = actual.mediumLow - data.judgement_mediumLow;
    data.error_medium     = actual.medium - data.judgement_medium;
    data.error_mediumHigh = actual.mediumHigh - data.judgement_mediumHigh;
    data.error_high       = actual.high - data.judgement_high;
  }

  function currentQuestionsComplete() {
    return data['perception'+'_'+data.levelOrder[currentLevel]] && data['judgement'+'_'+data.levelOrder[currentLevel]];
  }

  function showError(d) {
    d3.select('#cleveland').select('#error').text(d);
  }

  function clearError(d) {
    d3.select('#cleveland').select('#error').text('');
  }

  function currentAnswerIsNumber() {
    var d = data['judgement'+'_'+data.levelOrder[currentLevel]];
    return isNumber(d) ? (d >= 0 && d <= 100) : false;
  }

  function isNumber(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
  }

  function disableNextChartButton() {
    d3.select('#next-chart').attr('disabled', true);
  }

  function enableNextChartButton() {
    d3.select('#next-chart').attr('disabled', null);
  }

  function getRandomInt (min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function shuffle (o) {
    for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
      return o;
  }
}();
</script>
