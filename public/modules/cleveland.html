<form id='cleveland'>

<p>
Make a quick visual judgement:
</p>

<img id="cleveland-chart" height="300" />

<p>
Which of the two is smaller?
<input type="radio" name="perception" value="A" /> A
<input type="radio" name="perception" value="B" /> B
</p>

<p>
What percentage is the SMALLER of the LARGER? Enter a percentage between 0 and 100:
<br />
<br />
<input type="text" name="judgement" size="1" />%
</p>

<button type="button" disabled="true" id="next-chart">Next Chart</button>

</form>
  
<script> 
var cleveland = function() {
  var data         = {}
    , levels       = ['low', 'mediumLow', 'medium', 'mediumHigh', 'high']
    , currentLevel = 0
    , charts       = ['bar-adjacent', 'bar-nonadjacent'];

  data.chart      = charts[getRandomInt(0, 1)];
  data.levelOrder = shuffle(levels);

  init();

  function init() {
    d3.selectAll('input')
      .filter(function(d) { return this.name === 'perception' ? this : null; })
      .on('change', function() { data['perception'+'_'+data.levelOrder[currentLevel]] = this.value; validate(); });
    d3.selectAll('input')
      .filter(function(d) { return this.name === 'judgement' ? this : null; })
      .on('keypress', function() { data['judgement'+'_'+data.levelOrder[currentLevel]] = this.value; validate(); });
    d3.select('#next-chart')
      .on('click', nextChart);
    loadChart(0);
  }

  function nextChart() {
    currentLevel = currentLevel + 1;
    if( atLastChart() ){
      removeNextChartButton();
    }
    loadChart(currentLevel);
    resetAnswers();
    disableNextChartButton();
  }

  function removeNextChartButton() {
    d3.select('#next-chart').remove();
  }

  function atLastChart() {
    return currentLevel === data.levelOrder.length-1;
  }

  function loadChart(x) {
    var level = data.levelOrder[x];
    d3.select('#cleveland-chart')
      .attr('src', 'modules/img/'+data.chart+'-'+level+'.png');
  }

  function resetAnswers() {
    d3.select('#cleveland').node().reset();
  }

  function validate() {
    if( currentQuestionsComplete() ){
      enableNextChartButton();
    }
    if( allDataCollected() ) {
      experimentr.save(data);
      experimentr.release();
    }
  }

  function allDataCollected() {
    return data.perception_medium &&  data.judgement_medium &&
           data.perception_high   &&  data.judgement_high && 
           data.chart             &&  data.levelOrder;
  }

  function currentQuestionsComplete() {
    return data['perception'+'_'+data.levelOrder[currentLevel]] && data['judgement'+'_'+data.levelOrder[currentLevel]];
  }

  function disableNextChartButton() {
    d3.select('#next-chart').attr('disabled', true);
  }

  function enableNextChartButton() {
    d3.select('#next-chart').attr('disabled', null);
  }

  function getRandomInt (min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function shuffle (o) {
    for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
      return o;
  }
}();
</script>
