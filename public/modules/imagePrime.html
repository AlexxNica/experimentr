<div id="imagePrime">

<p id="imageInstructions">
<strong>Describe what's going on in the image.</strong>
</p>

<img id="images" />
<br>
<textarea id="imageComments" name="textarea" rows="10" cols="50">What's going on in this image?</textarea>
<br>
<button id="nextImage" disabled="true" type="button">Next Image</button>

</div>

<style>
</style>

<script> 
(function() {
  var data          = {}
    , nextButton    = d3.select('#nextImage')
    , textarea      = d3.select('#imageComments')
    , primingChoice = Math.floor(Math.random()*2)
    , currentImage  = 0
    , imageData;

  init();

  function init() {
    experimentr.hideNext();
    experimentr.startTimer('imagePrime');

    d3.json('modules/images.json', function(err, d) {
      data.primingType = primingChoice === 0 ? 'negative' : 'positive';
      imageData = d[data.primingType];
      loadImage(currentImage);
    });

    // textarea behavior
    textarea
      .on('keypress', function() { enableNextImage(); captureComments(); })
      .on('blur', function() { enableNextImage(); captureComments(); });

    // nextImage behavior
    nextButton.on('click', nextImage)
  }

  function enableNextImage() {
    nextButton.attr('disabled', null);
  }

  function loadImage(i) {
    d3.select('#images')
      .attr('width', 600)
      .attr('src', 'modules/img/iaps/'+imageData[i].id+'.jpg');
  }

  function nextImage() {
    if( currentImage + 1 === imageData.length - 1 ) lastImage();
    currentImage++;
    loadImage(currentImage);
    resetTextArea();
  }

  function lastImage() {
    nextButton.style('display', 'none');
    experimentr.release();
    experimentr.showNext();
    experimentr.onNext(function() {
      captureComments();
      experimentr.endTimer('imagePrime');
    });
  }

  function captureComments() {
    data['imageComments_'+currentImage] = textarea.property('value');
    experimentr.addData(data);
  }

  function resetTextArea() {
    textarea.property('value', 'What\'s going on in this image?');
  }

}());
</script>
